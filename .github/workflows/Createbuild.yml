name: Java CI/CD with Maven

# --------------------------------------------------
# Déclenchement :
# - develop  => environnement DEV (port 9091)
# - main     => environnement PROD (port 9092)
# --------------------------------------------------
on:
  push:
    branches: [ "develop", "main" ]
  workflow_dispatch:

jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1️⃣ Récupération du code source
      # --------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2️⃣ Installation de Java 17 (sur le runner GitHub)
      # --------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # --------------------------------------------------
      # 3️⃣ Build Maven (sans les tests pour aller plus vite)
      # --------------------------------------------------
      - name: Build application with Maven
        run: mvn clean package -DskipTests

      # --------------------------------------------------
      # 4️⃣ Normalisation du nom du JAR
      # IMPORTANT :
      # - on force un seul fichier : app.jar
      # - évite les erreurs de nom/version
      # --------------------------------------------------
      - name: Rename JAR to app.jar
        run: mv target/*.jar target/app.jar

      # --------------------------------------------------
      # 5️⃣ Copie du JAR vers la VM
      # IMPORTANT :
      # - on cible le FICHIER app.jar
      # - évite la création d'un dossier app.jar
      # --------------------------------------------------
      - name: Copy JAR to remote VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: target/app.jar
          target: |
            ${{ github.ref == 'refs/heads/develop'
              && '/opt/apps/dev/java/TestGithubActions/app.jar'
              || '/opt/apps/prod/java/TestGithubActions/app.jar' }}

      # --------------------------------------------------
      # 6️⃣ Démarrage de l'application sur la VM
      # --------------------------------------------------
      - name: Run Spring Boot application on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # ----------------------------------------------
            # Sélection de l'environnement selon la branche
            # ----------------------------------------------
            if [ "$GITHUB_REF" = "refs/heads/develop" ]; then
              APP_DIR="/opt/apps/dev/java/TestGithubActions"
              PORT=9091
              LOG_FILE="app-dev.log"
            else
              APP_DIR="/opt/apps/prod/java/TestGithubActions"
              PORT=9092
              LOG_FILE="app-prod.log"
            fi

            cd $APP_DIR || exit 1

            # ----------------------------------------------
            # Arrêt propre de l'application existante
            # (uniquement sur le port concerné)
            # ----------------------------------------------
            lsof -ti:$PORT | xargs kill -9 2>/dev/null || echo "Aucun processus à arrêter"

            sleep 2

            # ----------------------------------------------
            # Démarrage de la nouvelle version
            # ----------------------------------------------
            nohup java -jar app.jar --server.port=$PORT > $LOG_FILE 2>&1 &

            echo "✅ Application démarrée sur le port $PORT"
