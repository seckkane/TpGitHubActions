name: Java CI/CD with Maven

# ==============================================================================
# TRIGGERS
# - develop => DEV (port 9091)
# - main    => PROD (port 9092)
# ==============================================================================
on:
  push:
    branches: [ "develop", "main" ]
  workflow_dispatch:

# ==============================================================================
# VARIABLES GLOBALES
# ==============================================================================
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx1024m'

jobs:

  # ============================================================================
  # JOB 1 : BUILD & TEST
  # Compilation du code et crÃ©ation de l'artefact
  # ============================================================================
  build:
    name: ğŸ”¨ Build Application
    runs-on: ubuntu-latest

    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
      build-version: ${{ steps.version.outputs.version }}

    steps:
      # --------------------------------------------------------------------------
      # RÃ©cupÃ©ration du code source
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------------------------------
      # Configuration Java
      # --------------------------------------------------------------------------
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      # --------------------------------------------------------------------------
      # Extraction de la version depuis pom.xml
      # --------------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version dÃ©tectÃ©e: $VERSION"

      # --------------------------------------------------------------------------
      # Compilation et packaging
      # --------------------------------------------------------------------------
      - name: ğŸ”§ Build with Maven
        run: |
          echo "ğŸš€ DÃ©marrage de la compilation..."
          mvn clean package -DskipTests
          echo "âœ… Compilation terminÃ©e avec succÃ¨s"

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact produit
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify build artifact
        run: |
          if [ ! -f target/*.jar ]; then
            echo "âŒ Erreur: Aucun fichier JAR trouvÃ© dans target/"
            exit 1
          fi
          
          JAR_SIZE=$(du -h target/*.jar | cut -f1)
          echo "âœ… JAR trouvÃ© (taille: $JAR_SIZE)"
          ls -lh target/*.jar

      # --------------------------------------------------------------------------
      # Normalisation du nom du JAR
      # --------------------------------------------------------------------------
      - name: ğŸ“ Rename JAR to app.jar
        id: artifact
        run: |
          mv target/*.jar target/app.jar
          echo "name=app.jar" >> $GITHUB_OUTPUT
          echo "âœ… Fichier renommÃ©: app.jar"

      # --------------------------------------------------------------------------
      # Upload de l'artefact pour les jobs suivants
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          path: target/app.jar
          retention-days: 5

  # ============================================================================
  # JOB 2 : DETERMINATION DE L'ENVIRONNEMENT
  # Calcul des paramÃ¨tres selon la branche
  # ============================================================================
  configure:
    name: âš™ï¸ Configure Environment
    runs-on: ubuntu-latest
    needs: build

    outputs:
      app-dir: ${{ steps.config.outputs.app-dir }}
      port: ${{ steps.config.outputs.port }}
      log-file: ${{ steps.config.outputs.log-file }}
      env-name: ${{ steps.config.outputs.env-name }}
      branch: ${{ steps.config.outputs.branch }}

    steps:
      # --------------------------------------------------------------------------
      # DÃ©termination des paramÃ¨tres d'environnement
      # --------------------------------------------------------------------------
      - name: ğŸ¯ Set environment configuration
        id: config
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENV_NAME="DEV"
            APP_DIR="/opt/apps/dev/java/TestGithubActions"
            PORT="9091"
            LOG_FILE="app-dev.log"
          else
            ENV_NAME="PROD"
            APP_DIR="/opt/apps/prod/java/TestGithubActions"
            PORT="9092"
            LOG_FILE="app-prod.log"
          fi
          
          # Export des outputs
          echo "env-name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "app-dir=$APP_DIR" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "log-file=$LOG_FILE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Affichage rÃ©capitulatif
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Configuration du dÃ©ploiement"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Environnement : $ENV_NAME"
          echo "ğŸŒ¿ Branche       : $BRANCH_NAME"
          echo "ğŸ“‚ RÃ©pertoire    : $APP_DIR"
          echo "ğŸ”Œ Port          : $PORT"
          echo "ğŸ“„ Log           : $LOG_FILE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # JOB 3 : DEPLOIEMENT SUR LA VM
  # Transfert et dÃ©marrage de l'application
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to ${{ needs.configure.outputs.env-name }}
    runs-on: ubuntu-latest
    needs: [build, configure]

    environment:
      name: ${{ needs.configure.outputs.env-name }}
      url: http://207.180.240.150:${{ needs.configure.outputs.port }}

    steps:
      # --------------------------------------------------------------------------
      # TÃ©lÃ©chargement de l'artefact compilÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app
          path: ./artifact

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact tÃ©lÃ©chargÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "ğŸ“¦ Contenu du rÃ©pertoire artifact:"
          ls -lh ./artifact/
          
          if [ ! -f ./artifact/app.jar ]; then
            echo "âŒ Erreur: app.jar introuvable"
            exit 1
          fi
          
          JAR_SIZE=$(du -h ./artifact/app.jar | cut -f1)
          echo "âœ… Artefact vÃ©rifiÃ© (taille: $JAR_SIZE)"

      # --------------------------------------------------------------------------
      # CrÃ©ation du rÃ©pertoire distant
      # --------------------------------------------------------------------------
      - name: ğŸ“ Ensure remote directory exists
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ“ VÃ©rification du rÃ©pertoire: $APP_DIR"
            
            if [ ! -d "$APP_DIR" ]; then
              echo "ğŸ†• CrÃ©ation du rÃ©pertoire..."
              mkdir -p "$APP_DIR"
              echo "âœ… RÃ©pertoire crÃ©Ã©"
            else
              echo "âœ… RÃ©pertoire dÃ©jÃ  existant"
            fi
            
            # VÃ©rification des permissions
            if [ ! -w "$APP_DIR" ]; then
              echo "âŒ Erreur: Pas de permission d'Ã©criture sur $APP_DIR"
              exit 1
            fi
            
            echo "âœ… RÃ©pertoire prÃªt pour le dÃ©ploiement"

      # --------------------------------------------------------------------------
      # Transfert du JAR vers la VM avec SCP natif
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Transfer JAR to remote VM
        run: |
          # PrÃ©paration de la clÃ© SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Ajout du host aux known_hosts
          ssh-keyscan -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Transfert du fichier
          echo "ğŸ“¤ Transfert de app.jar vers la VM..."
          scp -i ~/.ssh/deploy_key \
              -P ${{ secrets.PORT }} \
              -o StrictHostKeyChecking=no \
              ./artifact/app.jar \
              ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ needs.configure.outputs.app-dir }}/app.jar
          
          echo "âœ… Transfert terminÃ©"
          
          # Nettoyage
          rm -f ~/.ssh/deploy_key

      # --------------------------------------------------------------------------
      # VÃ©rification du transfert
      # --------------------------------------------------------------------------
      - name: âœ… Verify transfer
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ” VÃ©rification du fichier transfÃ©rÃ©..."
            
            if [ -f "$APP_DIR/app.jar" ]; then
              JAR_SIZE=$(du -h "$APP_DIR/app.jar" | cut -f1)
              echo "âœ… Fichier prÃ©sent: $APP_DIR/app.jar ($JAR_SIZE)"
              ls -lh "$APP_DIR/app.jar"
            else
              echo "âŒ ERREUR: Fichier non trouvÃ© aprÃ¨s le transfert"
              echo "Contenu du rÃ©pertoire $APP_DIR:"
              ls -lah "$APP_DIR"
              exit 1
            fi

      # --------------------------------------------------------------------------
      # ArrÃªt de l'ancienne version
      # --------------------------------------------------------------------------
      - name: ğŸ›‘ Stop existing application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            PORT="${{ needs.configure.outputs.port }}"
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ” Recherche de processus sur le port $PORT..."
            
            # RÃ©cupÃ©ration du PID
            PID=$(lsof -ti:$PORT 2>/dev/null || echo "")
            
            if [ -n "$PID" ]; then
              echo "âš ï¸  Processus trouvÃ© (PID: $PID)"
              echo "ğŸ›‘ ArrÃªt en cours..."
            
              # Tentative d'arrÃªt gracieux
              kill -15 $PID 2>/dev/null
            
              # Attente de 5 secondes
              for i in {1..5}; do
                if ! kill -0 $PID 2>/dev/null; then
                  echo "âœ… Processus arrÃªtÃ© proprement"
                  break
                fi
                echo "â³ Attente... ($i/5)"
                sleep 1
              done
            
              # ArrÃªt forcÃ© si toujours actif
              if kill -0 $PID 2>/dev/null; then
                echo "âš ï¸  ArrÃªt forcÃ© nÃ©cessaire"
                kill -9 $PID 2>/dev/null
                sleep 2
                echo "âœ… Processus arrÃªtÃ© (forcÃ©)"
              fi
            else
              echo "â„¹ï¸  Aucun processus actif sur le port $PORT"
            fi
            
            # Nettoyage des logs anciens (garde les 5 derniers)
            cd $APP_DIR
            ls -t *.log 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true

      # --------------------------------------------------------------------------
      # DÃ©marrage de la nouvelle version
      # --------------------------------------------------------------------------
      - name: â–¶ï¸  Start new application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            PORT="${{ needs.configure.outputs.port }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            ENV_NAME="${{ needs.configure.outputs.env-name }}"
            
            cd $APP_DIR || exit 1
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ DÃ©marrage de l'application"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Environnement : $ENV_NAME"
            echo "ğŸ”Œ Port          : $PORT"
            echo "ğŸ“„ Log           : $LOG_FILE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # VÃ©rification finale du JAR
            if [ ! -f app.jar ]; then
              echo "âŒ ERREUR CRITIQUE: app.jar introuvable dans $APP_DIR"
              echo "Contenu du rÃ©pertoire:"
              ls -lah
              exit 1
            fi
            
            JAR_SIZE=$(du -h app.jar | cut -f1)
            echo "âœ… JAR trouvÃ©: $JAR_SIZE"
            
            # DÃ©marrage avec options JVM optimisÃ©es
            nohup java \
              -Xms256m \
              -Xmx512m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -Dspring.profiles.active=$(echo $ENV_NAME | tr '[:upper:]' '[:lower:]') \
              -jar app.jar \
              --server.port=$PORT \
              > $LOG_FILE 2>&1 &
            
            NEW_PID=$!
            echo "ğŸ†” PID du nouveau processus: $NEW_PID"
            
            # Sauvegarde du PID pour monitoring futur
            echo $NEW_PID > app.pid
            
            echo "â³ Attente du dÃ©marrage (10 secondes)..."
            sleep 10

  # ============================================================================
  # JOB 4 : VERIFICATION POST-DEPLOIEMENT
  # Tests de santÃ© et validation du dÃ©ploiement
  # ============================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [configure, deploy]

    steps:
      # --------------------------------------------------------------------------
      # VÃ©rification systÃ¨me (processus, port, fichiers)
      # --------------------------------------------------------------------------
      - name: ğŸ” System health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            PORT="${{ needs.configure.outputs.port }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            cd $APP_DIR || exit 1
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” VERIFICATION SYSTEME"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # 1ï¸âƒ£ VÃ©rification du processus Java
            echo ""
            echo "1ï¸âƒ£  Processus Java:"
            if ps aux | grep "[j]ava -jar app.jar" | grep -q "server.port=$PORT"; then
              PID=$(ps aux | grep "[j]ava -jar app.jar" | grep "server.port=$PORT" | awk '{print $2}')
              UPTIME=$(ps -p $PID -o etime= | tr -d ' ')
              MEM=$(ps -p $PID -o rss= | awk '{printf "%.2f MB", $1/1024}')
              echo "   âœ… Processus actif"
              echo "   ğŸ†” PID: $PID"
              echo "   â±ï¸  Uptime: $UPTIME"
              echo "   ğŸ’¾ MÃ©moire: $MEM"
            else
              echo "   âŒ ERREUR: Aucun processus Java trouvÃ©"
              exit 1
            fi
            
            # 2ï¸âƒ£ VÃ©rification du port
            echo ""
            echo "2ï¸âƒ£  Port d'Ã©coute:"
            if lsof -i:$PORT >/dev/null 2>&1; then
              echo "   âœ… Port $PORT en Ã©coute"
              lsof -i:$PORT | grep LISTEN | awk '{print "   ğŸ”Œ " $1 " (PID: " $2 ")"}'
            else
              echo "   âŒ ERREUR: Port $PORT non accessible"
              exit 1
            fi
            
            # 3ï¸âƒ£ VÃ©rification des fichiers
            echo ""
            echo "3ï¸âƒ£  Fichiers de l'application:"
            if [ -f app.jar ]; then
              JAR_SIZE=$(du -h app.jar | cut -f1)
              JAR_DATE=$(date -r app.jar "+%Y-%m-%d %H:%M:%S")
              echo "   âœ… app.jar prÃ©sent ($JAR_SIZE)"
              echo "   ğŸ“… Date: $JAR_DATE"
            else
              echo "   âŒ ERREUR: app.jar introuvable"
              exit 1
            fi
            
            if [ -f $LOG_FILE ]; then
              LOG_SIZE=$(du -h $LOG_FILE | cut -f1)
              LOG_LINES=$(wc -l < $LOG_FILE)
              echo "   âœ… $LOG_FILE prÃ©sent ($LOG_SIZE, $LOG_LINES lignes)"
            else
              echo "   âš ï¸  Fichier log non encore crÃ©Ã©"
            fi
            
            # 4ï¸âƒ£ Analyse des logs
            echo ""
            echo "4ï¸âƒ£  Analyse des logs (derniÃ¨res 30 lignes):"
            if [ -f $LOG_FILE ]; then
              # Recherche d'erreurs critiques
              if tail -100 $LOG_FILE | grep -qi "error\|exception\|failed"; then
                echo "   âš ï¸  AVERTISSEMENT: Erreurs dÃ©tectÃ©es dans les logs"
                echo ""
                echo "   ğŸ”´ Erreurs trouvÃ©es:"
                tail -100 $LOG_FILE | grep -i "error\|exception\|failed" | tail -5 | sed 's/^/      /'
              else
                echo "   âœ… Aucune erreur critique dÃ©tectÃ©e"
              fi
            
              # Recherche du message de dÃ©marrage rÃ©ussi
              if tail -100 $LOG_FILE | grep -q "Started.*Application in"; then
                STARTUP_TIME=$(tail -100 $LOG_FILE | grep "Started.*Application in" | tail -1 | grep -oP '\d+\.\d+(?= seconds)' || echo "N/A")
                echo "   âœ… Application dÃ©marrÃ©e avec succÃ¨s"
                echo "   âš¡ Temps de dÃ©marrage: ${STARTUP_TIME}s"
              else
                echo "   â³ DÃ©marrage en cours..."
              fi
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --------------------------------------------------------------------------
      # Test de connectivitÃ© HTTP
      # --------------------------------------------------------------------------
      - name: ğŸŒ HTTP connectivity test
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            PORT="${{ needs.configure.outputs.port }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ TEST DE CONNECTIVITE HTTP"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Tentatives de connexion (max 5)
            MAX_ATTEMPTS=5
            ATTEMPT=1
            SUCCESS=false
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ğŸ”„ Tentative $ATTEMPT/$MAX_ATTEMPTS..."
            
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT/ 2>/dev/null || echo "000")
            
              if [ "$HTTP_CODE" != "000" ]; then
                RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:$PORT/ 2>/dev/null)
                echo "   âœ… RÃ©ponse HTTP: $HTTP_CODE"
                echo "   âš¡ Temps de rÃ©ponse: ${RESPONSE_TIME}s"
                SUCCESS=true
                break
              else
                echo "   â³ Pas de rÃ©ponse, attente de 3 secondes..."
                sleep 3
              fi
            
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo ""
            
            if [ "$SUCCESS" = true ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… DEPLOIEMENT REUSSI"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸŒ URL: http://207.180.240.150:$PORT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ECHEC DU DEPLOIEMENT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "L'application ne rÃ©pond pas aprÃ¨s $MAX_ATTEMPTS tentatives"
              exit 1
            fi

      # --------------------------------------------------------------------------
      # Affichage des logs finaux (si Ã©chec)
      # --------------------------------------------------------------------------
      - name: ğŸ“‹ Display logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            cd $APP_DIR
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ LOGS DE L'APPLICATION (50 derniÃ¨res lignes)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -f $LOG_FILE ]; then
              tail -50 $LOG_FILE
            else
              echo "âŒ Fichier log introuvable"
            fi

  # ============================================================================
  # JOB 5 : NOTIFICATION
  # Envoyer des notifications en cas de succÃ¨s/Ã©chec
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [configure, verify]
    if: always()

    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          ENV_NAME="${{ needs.configure.outputs.env-name }}"
          PORT="${{ needs.configure.outputs.port }}"
          BRANCH="${{ needs.configure.outputs.branch }}"
          
          if [ "${{ needs.verify.result }}" = "success" ]; then
            STATUS="âœ… SUCCES"
            COLOR="ğŸŸ¢"
          else
            STATUS="âŒ ECHEC"
            COLOR="ğŸ”´"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$COLOR DEPLOIEMENT $ENV_NAME - $STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branche  : $BRANCH"
          echo "ğŸ“ Env      : $ENV_NAME"
          echo "ğŸ”Œ Port     : $PORT"
          echo "ğŸŒ URL      : http://207.180.240.150:$PORT"
          echo "ğŸ‘¤ Auteur   : ${{ github.actor }}"
          echo "ğŸ“ Commit   : ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"