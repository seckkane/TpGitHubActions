name: Java CI/CD with Maven

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:

  # =========================
  # 1️⃣ Créer les dossiers sur la VM
  # =========================
  Create-Folder:
    runs-on: ubuntu-latest
    steps:
      - name: Create DEV and PROD folders on remote VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -x
            echo "Création des dossiers applicatifs DEV et PROD"
            mkdir -p /opt/apps/dev/java/TestGithubActions
            mkdir -p /opt/apps/prod/java/TestGithubActions

  # =========================
  # 2️⃣ Build et déploiement commun
  # =========================
  Build-and-Deploy:
    runs-on: ubuntu-latest
    needs: Create-Folder
    steps:
      # 1️⃣ Checkout code
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2️⃣ Installer Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3️⃣ Build Maven
      - name: Build with Maven
        run: mvn -DskipTests=true -B package

      # 4️⃣ Renommer le JAR
      - name: Rename jar
        run: mv target/*.jar target/app.jar

      # 5️⃣ Copier le JAR vers DEV ou PROD selon la branche
      - name: Copy JAR to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: "target/app.jar"
          target: ${{ github.ref == 'refs/heads/develop' && '/opt/apps/dev/java/TestGithubActions' || '/opt/apps/prod/java/TestGithubActions' }}

  # =========================
  # 3️⃣ Lancer l'application sur la VM
  # =========================
  RunScript:
    runs-on: ubuntu-latest
    needs: Build-and-Deploy
    steps:
      - name: Run Spring Boot app on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Choisir environnement et port selon la branche
            if [ "${GITHUB_REF}" == "refs/heads/develop" ]; then
              APP_DIR="/opt/apps/dev/java/TestGithubActions"
              PORT=9091
              LOG_FILE="app-dev.log"
            else
              APP_DIR="/opt/apps/prod/java/TestGithubActions"
              PORT=9092
              LOG_FILE="app-prod.log"
            fi

            cd $APP_DIR

            # Kill seulement le processus sur le port correspondant
            lsof -ti:$PORT | xargs kill -9 2>/dev/null || echo "Aucun processus à arrêter"

            sleep 2

            # Lancer la nouvelle application
            nohup java -jar app.jar --server.port=$PORT > $LOG_FILE 2>&1 &

            sleep 2
            echo "Application lancée sur le port $PORT!"
