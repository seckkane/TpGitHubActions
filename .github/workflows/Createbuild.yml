name: Java CI/CD with Maven

# ==============================================================================
# TRIGGERS
# - develop => DEV (port 9091)
# - main    => PROD (port 9092)
# ==============================================================================
on:
  push:
    branches: [ "develop", "main" ]
  workflow_dispatch:

# ==============================================================================
# VARIABLES GLOBALES
# ==============================================================================
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx1024m'

jobs:

  # ============================================================================
  # JOB 1 : BUILD & TEST
  # Compilation du code et crÃ©ation de l'artefact
  # ============================================================================
  build:
    name: ğŸ”¨ Build Application
    runs-on: ubuntu-latest

    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
      build-version: ${{ steps.version.outputs.version }}

    steps:
      # --------------------------------------------------------------------------
      # RÃ©cupÃ©ration du code source
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------------------------------
      # Configuration Java
      # --------------------------------------------------------------------------
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      # --------------------------------------------------------------------------
      # Extraction de la version depuis pom.xml
      # --------------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version dÃ©tectÃ©e: $VERSION"

      # --------------------------------------------------------------------------
      # Compilation et packaging
      # --------------------------------------------------------------------------
      - name: ğŸ”§ Build with Maven
        run: |
          echo "ğŸš€ DÃ©marrage de la compilation..."
          mvn clean package -DskipTests
          echo "âœ… Compilation terminÃ©e avec succÃ¨s"

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact produit
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify build artifact
        run: |
          if [ ! -f target/*.jar ]; then
            echo "âŒ Erreur: Aucun fichier JAR trouvÃ© dans target/"
            exit 1
          fi
          
          JAR_SIZE=$(du -h target/*.jar | cut -f1)
          echo "âœ… JAR trouvÃ© (taille: $JAR_SIZE)"
          ls -lh target/*.jar

      # --------------------------------------------------------------------------
      # Normalisation du nom du JAR
      # --------------------------------------------------------------------------
      - name: ğŸ“ Rename JAR to app.jar
        id: artifact
        run: |
          mv target/*.jar target/app.jar
          echo "name=app.jar" >> $GITHUB_OUTPUT
          echo "âœ… Fichier renommÃ©: app.jar"

      # --------------------------------------------------------------------------
      # Upload de l'artefact pour les jobs suivants
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          path: target/app.jar
          retention-days: 5

  # ============================================================================
  # JOB 2 : DETERMINATION DE L'ENVIRONNEMENT
  # Calcul des paramÃ¨tres selon la branche
  # ============================================================================
  configure:
    name: âš™ï¸ Configure Environment
    runs-on: ubuntu-latest
    needs: build

    outputs:
      app-dir: ${{ steps.config.outputs.app-dir }}
      port: ${{ steps.config.outputs.port }}
      log-file: ${{ steps.config.outputs.log-file }}
      env-name: ${{ steps.config.outputs.env-name }}
      branch: ${{ steps.config.outputs.branch }}

    steps:
      # --------------------------------------------------------------------------
      # DÃ©termination des paramÃ¨tres d'environnement
      # --------------------------------------------------------------------------
      - name: ğŸ¯ Set environment configuration
        id: config
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENV_NAME="DEV"
            APP_DIR="/opt/apps/dev/java/TestGithubActions"
            PORT="9091"
            LOG_FILE="app-dev.log"
          else
            ENV_NAME="PROD"
            APP_DIR="/opt/apps/prod/java/TestGithubActions"
            PORT="9092"
            LOG_FILE="app-prod.log"
          fi
          
          # Export des outputs
          echo "env-name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "app-dir=$APP_DIR" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "log-file=$LOG_FILE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Affichage rÃ©capitulatif
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Configuration du dÃ©ploiement"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Environnement : $ENV_NAME"
          echo "ğŸŒ¿ Branche       : $BRANCH_NAME"
          echo "ğŸ“‚ RÃ©pertoire    : $APP_DIR"
          echo "ğŸ”Œ Port          : $PORT"
          echo "ğŸ“„ Log           : $LOG_FILE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # JOB 3 : DEPLOIEMENT SUR LA VM
  # Transfert et dÃ©marrage de l'application
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to ${{ needs.configure.outputs.env-name }}
    runs-on: ubuntu-latest
    needs: [build, configure]

    environment:
      name: ${{ needs.configure.outputs.env-name }}
      url: http://207.180.240.150:${{ needs.configure.outputs.port }}

    steps:
      # --------------------------------------------------------------------------
      # TÃ©lÃ©chargement de l'artefact compilÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app
          path: ./artifact

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact tÃ©lÃ©chargÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "ğŸ“¦ Contenu du rÃ©pertoire artifact:"
          ls -lh ./artifact/
          
          if [ ! -f ./artifact/app.jar ]; then
            echo "âŒ Erreur: app.jar introuvable"
            exit 1
          fi
          
          # VÃ©rification que c'est bien un fichier et non un dossier
          if [ -d ./artifact/app.jar ]; then
            echo "âŒ Erreur: app.jar est un dossier, pas un fichier"
            exit 1
          fi
          
          JAR_SIZE=$(du -h ./artifact/app.jar | cut -f1)
          echo "âœ… Artefact vÃ©rifiÃ© (taille: $JAR_SIZE)"
          file ./artifact/app.jar

      # --------------------------------------------------------------------------
      # CrÃ©ation et nettoyage du rÃ©pertoire distant
      # --------------------------------------------------------------------------
      - name: ğŸ“ Prepare remote directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ§¹ PrÃ©paration du rÃ©pertoire: $APP_DIR"
            
            # CrÃ©ation du rÃ©pertoire parent si nÃ©cessaire
            mkdir -p "$APP_DIR"
            
            # Suppression des anciens fichiers/dossiers problÃ©matiques
            rm -rf "$APP_DIR/app.jar" "$APP_DIR/artifact" "$APP_DIR/target"
            
            # VÃ©rification des permissions
            if [ ! -w "$APP_DIR" ]; then
              echo "âŒ Erreur: Pas de permission d'Ã©criture sur $APP_DIR"
              exit 1
            fi
            
            echo "âœ… RÃ©pertoire prÃªt pour le dÃ©ploiement"

      # --------------------------------------------------------------------------
      # Transfert du JAR avec base64 (100% fiable)
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Transfer JAR to remote VM
        run: |
          # PrÃ©paration de la clÃ© SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Ajout du host aux known_hosts
          ssh-keyscan -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Affichage de diagnostic
          echo "ğŸ“¦ Informations sur le fichier source:"
          ls -lh ./artifact/app.jar
          file ./artifact/app.jar
          du -h ./artifact/app.jar
          echo ""
          
          # Encodage et transfert via base64 (Ã©vite tous les problÃ¨mes de SCP)
          echo "ğŸ“¤ Transfert de app.jar vers la VM..."
          base64 ./artifact/app.jar | ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.PORT }} \
              -o StrictHostKeyChecking=no \
              "${{ secrets.USERNAME }}@${{ secrets.HOST }}" \
              "base64 -d > ${{ needs.configure.outputs.app-dir }}/app.jar"
          
          echo "âœ… Transfert terminÃ©"
          
          # Nettoyage
          rm -f ~/.ssh/deploy_key

      # --------------------------------------------------------------------------
      # VÃ©rification du transfert
      # --------------------------------------------------------------------------
      - name: âœ… Verify transfer
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ” VÃ©rification du fichier transfÃ©rÃ©..."
            echo ""
            
            # VÃ©rification de l'existence
            if [ ! -e "$APP_DIR/app.jar" ]; then
              echo "âŒ ERREUR: app.jar n'existe pas"
              echo "Contenu du rÃ©pertoire $APP_DIR:"
              ls -lah "$APP_DIR"
              exit 1
            fi
            
            # VÃ©rification que c'est un fichier (pas un dossier)
            if [ -d "$APP_DIR/app.jar" ]; then
              echo "âŒ ERREUR: app.jar est un dossier, pas un fichier"
              echo "Contenu de app.jar:"
              ls -lah "$APP_DIR/app.jar"
              exit 1
            fi
            
            # VÃ©rification que c'est un fichier
            if [ ! -f "$APP_DIR/app.jar" ]; then
              echo "âŒ ERREUR: app.jar n'est pas un fichier rÃ©gulier"
              file "$APP_DIR/app.jar"
              exit 1
            fi
            
            # Affichage des informations
            JAR_SIZE=$(du -h "$APP_DIR/app.jar" | cut -f1)
            echo "âœ… Fichier JAR transfÃ©rÃ© avec succÃ¨s"
            echo "   ğŸ“ Chemin: $APP_DIR/app.jar"
            echo "   ğŸ“¦ Taille: $JAR_SIZE"
            echo ""
            ls -lh "$APP_DIR/app.jar"
            file "$APP_DIR/app.jar"

      # --------------------------------------------------------------------------
      # ArrÃªt de l'ancienne version
      # --------------------------------------------------------------------------
      - name: ğŸ›‘ Stop existing application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            PORT="${{ needs.configure.outputs.port }}"
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ” Recherche de processus sur le port $PORT..."
            
            # RÃ©cupÃ©ration du PID
            PID=$(lsof -ti:$PORT 2>/dev/null || echo "")
            
            if [ -n "$PID" ]; then
              echo "âš ï¸  Processus trouvÃ© (PID: $PID)"
              echo "ğŸ›‘ ArrÃªt en cours..."
            
              # Tentative d'arrÃªt gracieux
              kill -15 $PID 2>/dev/null
            
              # Attente de 5 secondes
              for i in {1..5}; do
                if ! kill -0 $PID 2>/dev/null; then
                  echo "âœ… Processus arrÃªtÃ© proprement"
                  break
                fi
                echo "â³ Attente... ($i/5)"
                sleep 1
              done
            
              # ArrÃªt forcÃ© si toujours actif
              if kill -0 $PID 2>/dev/null; then
                echo "âš ï¸  ArrÃªt forcÃ© nÃ©cessaire"
                kill -9 $PID 2>/dev/null
                sleep 2
                echo "âœ… Processus arrÃªtÃ© (forcÃ©)"
              fi
            else
              echo "â„¹ï¸  Aucun processus actif sur le port $PORT"
            fi
            
            # Nettoyage des logs anciens (garde les 5 derniers)
            cd $APP_DIR
            ls -t *.log 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true

      # --------------------------------------------------------------------------
      # DÃ©marrage de la nouvelle version avec logs immÃ©diats
      # --------------------------------------------------------------------------
      - name: â–¶ï¸  Start new application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            PORT="${{ needs.configure.outputs.port }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            ENV_NAME="${{ needs.configure.outputs.env-name }}"
            
            cd $APP_DIR || exit 1
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ DÃ©marrage de l'application"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Environnement : $ENV_NAME"
            echo "ğŸ”Œ Port          : $PORT"
            echo "ğŸ“„ Log           : $LOG_FILE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # VÃ©rification finale du JAR
            if [ ! -f app.jar ]; then
              echo "âŒ ERREUR CRITIQUE: app.jar introuvable dans $APP_DIR"
              echo "Contenu du rÃ©pertoire:"
              ls -lah
              exit 1
            fi
            
            # VÃ©rification que c'est un fichier
            if [ -d app.jar ]; then
              echo "âŒ ERREUR CRITIQUE: app.jar est un dossier"
              exit 1
            fi
            
            JAR_SIZE=$(du -h app.jar | cut -f1)
            echo "âœ… JAR trouvÃ©: $JAR_SIZE"
            
            # Test que le JAR est exÃ©cutable
            echo ""
            echo "ğŸ” Test de validitÃ© du JAR..."
            if ! java -jar app.jar --version 2>&1 | head -5; then
              echo "âš ï¸  Commande --version non supportÃ©e, test avec unzip..."
              if ! unzip -t app.jar > /dev/null 2>&1; then
                echo "âŒ ERREUR: Le fichier JAR est corrompu"
                exit 1
              fi
            fi
            echo "âœ… JAR valide"
            echo ""
            
            # Suppression de l'ancien log pour un nouveau dÃ©marrage propre
            rm -f $LOG_FILE
            
            # DÃ©marrage avec options JVM optimisÃ©es
            echo "ğŸš€ Lancement de Java..."
            nohup java \
              -Xms256m \
              -Xmx512m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -Dspring.profiles.active=$(echo $ENV_NAME | tr '[:upper:]' '[:lower:]') \
              -jar app.jar \
              --server.port=$PORT \
              > $LOG_FILE 2>&1 &
            
            NEW_PID=$!
            echo "ğŸ†” PID du nouveau processus: $NEW_PID"
            
            # VÃ©rification immÃ©diate que le processus existe
            sleep 1
            if ! kill -0 $NEW_PID 2>/dev/null; then
              echo "âŒ ERREUR: Le processus s'est arrÃªtÃ© immÃ©diatement"
              echo ""
              echo "ğŸ“‹ Logs de dÃ©marrage:"
              cat $LOG_FILE
              exit 1
            fi
            
            # Sauvegarde du PID
            echo $NEW_PID > app.pid
            
            echo "â³ Attente du dÃ©marrage (15 secondes)..."
            sleep 15
            
            # VÃ©rification que le processus tourne toujours
            if ! kill -0 $NEW_PID 2>/dev/null; then
              echo "âŒ ERREUR: Le processus s'est arrÃªtÃ© pendant le dÃ©marrage"
              echo ""
              echo "ğŸ“‹ Logs complets:"
              cat $LOG_FILE
              exit 1
            fi
            
            echo "âœ… Processus toujours actif aprÃ¨s 15 secondes"
            
            # Affichage des premiÃ¨res lignes du log
            echo ""
            echo "ğŸ“‹ PremiÃ¨res lignes du log:"
            head -20 $LOG_FILE

  # ============================================================================
  # JOB 4 : VERIFICATION POST-DEPLOIEMENT
  # Tests de santÃ© et validation du dÃ©ploiement
  # ============================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [configure, deploy]

    steps:
      # --------------------------------------------------------------------------
      # Affichage des logs AVANT les vÃ©rifications
      # --------------------------------------------------------------------------
      - name: ğŸ“‹ Display startup logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            cd $APP_DIR
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ LOGS DE DEMARRAGE (50 premiÃ¨res lignes)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -f $LOG_FILE ]; then
              head -50 $LOG_FILE
            else
              echo "âŒ Fichier log introuvable: $LOG_FILE"
              echo "Contenu du rÃ©pertoire:"
              ls -lah
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --------------------------------------------------------------------------
      # VÃ©rification systÃ¨me (processus, port, fichiers)
      # --------------------------------------------------------------------------
      - name: ğŸ” System health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            PORT="${{ needs.configure.outputs.port }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            cd $APP_DIR || exit 1
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” VERIFICATION SYSTEME"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # 1ï¸âƒ£ VÃ©rification du processus Java
            echo ""
            echo "1ï¸âƒ£  Processus Java:"
            
            # Recherche du processus par PID sauvegardÃ©
            if [ -f app.pid ]; then
              SAVED_PID=$(cat app.pid)
              echo "   ğŸ“‹ PID sauvegardÃ©: $SAVED_PID"
            
              if kill -0 $SAVED_PID 2>/dev/null; then
                UPTIME=$(ps -p $SAVED_PID -o etime= | tr -d ' ')
                MEM=$(ps -p $SAVED_PID -o rss= | awk '{printf "%.2f MB", $1/1024}')
                CMD=$(ps -p $SAVED_PID -o cmd= | head -c 80)
                echo "   âœ… Processus actif (PID: $SAVED_PID)"
                echo "   â±ï¸  Uptime: $UPTIME"
                echo "   ğŸ’¾ MÃ©moire: $MEM"
                echo "   ğŸ“ Commande: $CMD"
              else
                echo "   âŒ Le processus PID $SAVED_PID n'existe plus"
                echo ""
                echo "   ğŸ” Recherche d'autres processus Java..."
                ps aux | grep "[j]ava" || echo "   Aucun processus Java trouvÃ©"
                echo ""
                echo "   ğŸ“‹ DerniÃ¨res lignes du log:"
                tail -30 $LOG_FILE
                exit 1
              fi
            else
              # Recherche alternative par port
              if ps aux | grep "[j]ava -jar app.jar" | grep -q "server.port=$PORT"; then
                PID=$(ps aux | grep "[j]ava -jar app.jar" | grep "server.port=$PORT" | awk '{print $2}')
                UPTIME=$(ps -p $PID -o etime= | tr -d ' ')
                MEM=$(ps -p $PID -o rss= | awk '{printf "%.2f MB", $1/1024}')
                echo "   âœ… Processus actif (PID: $PID)"
                echo "   â±ï¸  Uptime: $UPTIME"
                echo "   ğŸ’¾ MÃ©moire: $MEM"
              else
                echo "   âŒ ERREUR: Aucun processus Java trouvÃ©"
                echo ""
                echo "   ğŸ” Tous les processus Java sur le systÃ¨me:"
                ps aux | grep "[j]ava" || echo "   Aucun"
                echo ""
                echo "   ğŸ“‹ Contenu complet du log:"
                cat $LOG_FILE 2>/dev/null || echo "   Log introuvable"
                exit 1
              fi
            fi
            
            # 2ï¸âƒ£ VÃ©rification du port
            echo ""
            echo "2ï¸âƒ£  Port d'Ã©coute:"
            if lsof -i:$PORT >/dev/null 2>&1; then
              echo "   âœ… Port $PORT en Ã©coute"
              lsof -i:$PORT | grep LISTEN | awk '{print "   ğŸ”Œ " $1 " (PID: " $2 ")"}'
            else
              echo "   âŒ ERREUR: Port $PORT non accessible"
              echo ""
              echo "   ğŸ” Tous les ports en Ã©coute:"
              lsof -i -P -n | grep LISTEN | head -20
              exit 1
            fi
            
            # 3ï¸âƒ£ VÃ©rification des fichiers
            echo ""
            echo "3ï¸âƒ£  Fichiers de l'application:"
            if [ -f app.jar ]; then
              JAR_SIZE=$(du -h app.jar | cut -f1)
              JAR_DATE=$(date -r app.jar "+%Y-%m-%d %H:%M:%S")
              echo "   âœ… app.jar prÃ©sent ($JAR_SIZE)"
              echo "   ğŸ“… Date: $JAR_DATE"
            else
              echo "   âŒ ERREUR: app.jar introuvable"
              exit 1
            fi
            
            if [ -f $LOG_FILE ]; then
              LOG_SIZE=$(du -h $LOG_FILE | cut -f1)
              LOG_LINES=$(wc -l < $LOG_FILE)
              echo "   âœ… $LOG_FILE prÃ©sent ($LOG_SIZE, $LOG_LINES lignes)"
            else
              echo "   âš ï¸  Fichier log non encore crÃ©Ã©"
            fi
            
            # 4ï¸âƒ£ Analyse des logs
            echo ""
            echo "4ï¸âƒ£  Analyse des logs:"
            if [ -f $LOG_FILE ]; then
              # Recherche d'erreurs critiques
              if tail -100 $LOG_FILE | grep -qi "error\|exception\|failed"; then
                echo "   âš ï¸  AVERTISSEMENT: Erreurs dÃ©tectÃ©es dans les logs"
                echo ""
                echo "   ğŸ”´ Erreurs trouvÃ©es:"
                tail -100 $LOG_FILE | grep -i "error\|exception\|failed" | tail -5 | sed 's/^/      /'
              else
                echo "   âœ… Aucune erreur critique dÃ©tectÃ©e"
              fi
            
              # Recherche du message de dÃ©marrage rÃ©ussi
              if tail -100 $LOG_FILE | grep -q "Started.*Application in"; then
                STARTUP_TIME=$(tail -100 $LOG_FILE | grep "Started.*Application in" | tail -1 | grep -oP '\d+\.\d+(?= seconds)' || echo "N/A")
                echo "   âœ… Application dÃ©marrÃ©e avec succÃ¨s"
                echo "   âš¡ Temps de dÃ©marrage: ${STARTUP_TIME}s"
              else
                echo "   â³ Message de dÃ©marrage non trouvÃ©"
                echo "   ğŸ“‹ DerniÃ¨res 10 lignes du log:"
                tail -10 $LOG_FILE | sed 's/^/      /'
              fi
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --------------------------------------------------------------------------
      # Test de connectivitÃ© HTTP
      # --------------------------------------------------------------------------
      - name: ğŸŒ HTTP connectivity test
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            PORT="${{ needs.configure.outputs.port }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ TEST DE CONNECTIVITE HTTP"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Tentatives de connexion (max 10 pour Spring Boot qui peut Ãªtre long)
            MAX_ATTEMPTS=10
            ATTEMPT=1
            SUCCESS=false
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ğŸ”„ Tentative $ATTEMPT/$MAX_ATTEMPTS..."
            
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT/ 2>/dev/null || echo "000")
            
              if [ "$HTTP_CODE" != "000" ]; then
                RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:$PORT/ 2>/dev/null)
                echo "   âœ… RÃ©ponse HTTP: $HTTP_CODE"
                echo "   âš¡ Temps de rÃ©ponse: ${RESPONSE_TIME}s"
                SUCCESS=true
                break
              else
                echo "   â³ Pas de rÃ©ponse, attente de 5 secondes..."
                sleep 5
              fi
            
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo ""
            
            if [ "$SUCCESS" = true ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… DEPLOIEMENT REUSSI"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸŒ URL: http://207.180.240.150:$PORT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ECHEC DU DEPLOIEMENT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "L'application ne rÃ©pond pas aprÃ¨s $MAX_ATTEMPTS tentatives"
              exit 1
            fi

      # --------------------------------------------------------------------------
      # Affichage des logs finaux (si Ã©chec)
      # --------------------------------------------------------------------------
      - name: ğŸ“‹ Display full logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            cd $APP_DIR
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ LOGS COMPLETS DE L'APPLICATION"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ -f $LOG_FILE ]; then
              cat $LOG_FILE
            else
              echo "âŒ Fichier log introuvable: $LOG_FILE"
              echo ""
              echo "Contenu du rÃ©pertoire:"
              ls -lah
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # JOB 5 : NOTIFICATION
  # Envoyer des notifications en cas de succÃ¨s/Ã©chec
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [configure, verify]
    if: always()

    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          ENV_NAME="${{ needs.configure.outputs.env-name }}"
          PORT="${{ needs.configure.outputs.port }}"
          BRANCH="${{ needs.configure.outputs.branch }}"
          
          if [ "${{ needs.verify.result }}" = "success" ]; then
            STATUS="âœ… SUCCES"
            COLOR="ğŸŸ¢"
          else
            STATUS="âŒ ECHEC"
            COLOR="ğŸ”´"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$COLOR DEPLOIEMENT $ENV_NAME - $STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branche  : $BRANCH"
          echo "ğŸ“ Env      : $ENV_NAME"
          echo "ğŸ”Œ Port     : $PORT"
          echo "ğŸŒ URL      : http://207.180.240.150:$PORT"
          echo "ğŸ‘¤ Auteur   : ${{ github.actor }}"
          echo "ğŸ“ Commit   : ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"