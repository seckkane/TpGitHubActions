name: Java CI/CD with Maven

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:

  # =========================
  # 1️⃣ Créer les dossiers DEV et PROD sur la VM
  # =========================
  Create-Folders:
    runs-on: ubuntu-latest
    steps:
      - name: Create DEV and PROD folders on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -x
            echo "Création des dossiers applicatifs DEV et PROD si inexistants"
            mkdir -p /opt/apps/dev/java/TestGithubActions
            mkdir -p /opt/apps/prod/java/TestGithubActions

  # =========================
  # 2️⃣ Build Maven + Copier le JAR sur la VM
  # =========================
  Build-and-Deploy:
    runs-on: ubuntu-latest
    needs: Create-Folders
    steps:
      # 2.1️⃣ Checkout code
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2.2️⃣ Installer Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 2.3️⃣ Build Maven
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 2.4️⃣ Renommer le JAR dans target
      - name: Rename JAR
        run: mv target/*.jar target/app.jar

      # 2.5️⃣ Copier le JAR directement dans le dossier d'exécution
      - name: Copy JAR to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: "target/app.jar"
          target: ${{ github.ref == 'refs/heads/develop' && '/opt/apps/dev/java/TestGithubActions/app.jar' || '/opt/apps/prod/java/TestGithubActions/app.jar' }}

  # =========================
  # 3️⃣ Lancer l'application sur la VM avec port dynamique
  # =========================
  RunScript:
    runs-on: ubuntu-latest
    needs: Build-and-Deploy
    steps:
      - name: Run Spring Boot app on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # =========================
            # Déterminer l'environnement en fonction de la branche
            # =========================
            BRANCH_NAME=$(basename $GITHUB_REF)

            if [ "$BRANCH_NAME" = "develop" ]; then
              ENV_DIR="/opt/apps/dev/java/TestGithubActions"
              PORT=9091
              LOG_FILE="app-dev.log"
            else
              ENV_DIR="/opt/apps/prod/java/TestGithubActions"
              PORT=9092
              LOG_FILE="app-prod.log"
            fi

            cd $ENV_DIR

            # =========================
            # Arrêter l'application si elle tourne déjà sur ce port
            # =========================
            lsof -ti:$PORT | xargs kill -9 2>/dev/null || echo "Aucun processus à arrêter"

            sleep 2

            # =========================
            # Lancer la nouvelle application avec port dynamique
            # =========================
            nohup java -jar app.jar --SERVER_PORT=$PORT > $LOG_FILE 2>&1 &

            sleep 2
            echo "Application lancée sur le port $PORT avec log $LOG_FILE"

  # =========================
  # 4️⃣ Vérification automatique que l'app écoute sur le bon port
  # =========================
  VerifyApp:
    runs-on: ubuntu-latest
    needs: RunScript
    steps:
      - name: Verify DEV/PROD port and logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            BRANCH_NAME=$(basename $GITHUB_REF)

            if [ "$BRANCH_NAME" = "develop" ]; then
              PORT=9091
              ENV_DIR="/opt/apps/dev/java/TestGithubActions"
              LOG_FILE="app-dev.log"
            else
              PORT=9092
              ENV_DIR="/opt/apps/prod/java/TestGithubActions"
              LOG_FILE="app-prod.log"
            fi

            # Vérifier si le port est occupé
            if ss -tulnp | grep -q ":$PORT"; then
              echo "✅ Application en écoute sur le port $PORT"
            else
              echo "❌ Application NON démarrée sur le port $PORT"
            fi

            # Afficher les 10 dernières lignes du log
            tail -n 10 $ENV_DIR/$LOG_FILE
