name: Java CI/CD with Maven

# ==============================================================================
# TRIGGERS
# - develop => DEV (port 9091)
# - main    => PROD (port 9092)
# ==============================================================================
on:
  push:
    branches: [ "develop", "main" ]
  workflow_dispatch:

# ==============================================================================
# VARIABLES GLOBALES
# ==============================================================================
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx1024m'

jobs:

  # ============================================================================
  # JOB 1 : BUILD & TEST
  # Compilation du code et exÃ©cution des tests
  # ============================================================================
  build:
    name: ğŸ”¨ Build & Test Application
    runs-on: ubuntu-latest

    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
      build-version: ${{ steps.version.outputs.version }}
      tests-passed: ${{ steps.tests.outputs.passed }}

    steps:
      # --------------------------------------------------------------------------
      # RÃ©cupÃ©ration du code source
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------------------------------
      # Configuration Java
      # --------------------------------------------------------------------------
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      # --------------------------------------------------------------------------
      # Extraction de la version depuis pom.xml
      # --------------------------------------------------------------------------
      - name: ğŸ·ï¸ Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version dÃ©tectÃ©e: $VERSION"

      # --------------------------------------------------------------------------
      # âœ… AMÃ‰LIORATION 1 : ExÃ©cution des tests automatisÃ©s
      # --------------------------------------------------------------------------
      - name: ğŸ§ª Run unit tests
        id: tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests unitaires..."
          
          # ExÃ©cution des tests avec rapport dÃ©taillÃ©
          mvn test -B
          
          # VÃ©rification du rÃ©sultat
          if [ $? -eq 0 ]; then
            echo "âœ… Tous les tests sont passÃ©s"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Des tests ont Ã©chouÃ©"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # --------------------------------------------------------------------------
      # Affichage du rapport de tests
      # --------------------------------------------------------------------------
      - name: ğŸ“Š Display test summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RAPPORT DE TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f target/surefire-reports/*.xml ]; then
            # Comptage des tests
            TOTAL=$(grep -r "tests=" target/surefire-reports/*.xml | head -1 | sed 's/.*tests="\([0-9]*\)".*/\1/')
            FAILURES=$(grep -r "failures=" target/surefire-reports/*.xml | head -1 | sed 's/.*failures="\([0-9]*\)".*/\1/')
            ERRORS=$(grep -r "errors=" target/surefire-reports/*.xml | head -1 | sed 's/.*errors="\([0-9]*\)".*/\1/')
            SUCCESS=$((TOTAL - FAILURES - ERRORS))
          
            echo "âœ… Tests rÃ©ussis  : $SUCCESS"
            echo "âŒ Tests Ã©chouÃ©s  : $FAILURES"
            echo "âš ï¸  Erreurs       : $ERRORS"
            echo "ğŸ“ Total         : $TOTAL"
          else
            echo "â„¹ï¸  Aucun rapport de test disponible"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --------------------------------------------------------------------------
      # Upload des rapports de tests
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/
          retention-days: 30

      # --------------------------------------------------------------------------
      # Compilation et packaging (aprÃ¨s tests rÃ©ussis)
      # --------------------------------------------------------------------------
      - name: ğŸ”§ Build application with Maven
        run: |
          echo "ğŸš€ DÃ©marrage de la compilation..."
          mvn clean package -DskipTests
          echo "âœ… Compilation terminÃ©e avec succÃ¨s"

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact produit
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify build artifact
        run: |
          if [ ! -f target/*.jar ]; then
            echo "âŒ Erreur: Aucun fichier JAR trouvÃ© dans target/"
            exit 1
          fi
          
          JAR_SIZE=$(du -h target/*.jar | cut -f1)
          echo "âœ… JAR trouvÃ© (taille: $JAR_SIZE)"
          ls -lh target/*.jar

      # --------------------------------------------------------------------------
      # Normalisation du nom du JAR
      # --------------------------------------------------------------------------
      - name: ğŸ“ Rename JAR to app.jar
        id: artifact
        run: |
          mv target/*.jar target/app.jar
          echo "name=app.jar" >> $GITHUB_OUTPUT
          echo "âœ… Fichier renommÃ©: app.jar"

      # --------------------------------------------------------------------------
      # Upload de l'artefact pour les jobs suivants
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          path: target/app.jar
          retention-days: 5

  # ============================================================================
  # JOB 2 : DETERMINATION DE L'ENVIRONNEMENT
  # Calcul des paramÃ¨tres selon la branche
  # ============================================================================
  configure:
    name: âš™ï¸ Configure Environment
    runs-on: ubuntu-latest
    needs: build

    outputs:
      app-dir: ${{ steps.config.outputs.app-dir }}
      port: ${{ steps.config.outputs.port }}
      log-file: ${{ steps.config.outputs.log-file }}
      env-name: ${{ steps.config.outputs.env-name }}
      branch: ${{ steps.config.outputs.branch }}
      service-name: ${{ steps.config.outputs.service-name }}

    steps:
      # --------------------------------------------------------------------------
      # DÃ©termination des paramÃ¨tres d'environnement
      # --------------------------------------------------------------------------
      - name: ğŸ¯ Set environment configuration
        id: config
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENV_NAME="DEV"
            APP_DIR="/opt/apps/dev/java/TestGithubActions"
            PORT="9091"
            LOG_FILE="app-dev.log"
            SERVICE_NAME="testgithubactions-dev"
          else
            ENV_NAME="PROD"
            APP_DIR="/opt/apps/prod/java/TestGithubActions"
            PORT="9092"
            LOG_FILE="app-prod.log"
            SERVICE_NAME="testgithubactions-prod"
          fi
          
          # Export des outputs
          echo "env-name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "app-dir=$APP_DIR" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "log-file=$LOG_FILE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "service-name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          
          # Affichage rÃ©capitulatif
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Configuration du dÃ©ploiement"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Environnement : $ENV_NAME"
          echo "ğŸŒ¿ Branche       : $BRANCH_NAME"
          echo "ğŸ“‚ RÃ©pertoire    : $APP_DIR"
          echo "ğŸ”Œ Port          : $PORT"
          echo "ğŸ“„ Log           : $LOG_FILE"
          echo "ğŸ”§ Service       : $SERVICE_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # JOB 3 : DEPLOIEMENT SUR LA VM
  # Transfert et dÃ©marrage de l'application
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to ${{ needs.configure.outputs.env-name }}
    runs-on: ubuntu-latest
    needs: [build, configure]

    environment:
      name: ${{ needs.configure.outputs.env-name }}
      url: http://207.180.240.150:${{ needs.configure.outputs.port }}

    steps:
      # --------------------------------------------------------------------------
      # TÃ©lÃ©chargement de l'artefact compilÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app
          path: ./artifact

      # --------------------------------------------------------------------------
      # VÃ©rification de l'artefact tÃ©lÃ©chargÃ©
      # --------------------------------------------------------------------------
      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "ğŸ“¦ Contenu du rÃ©pertoire artifact:"
          ls -lh ./artifact/
          
          if [ ! -f ./artifact/app.jar ]; then
            echo "âŒ Erreur: app.jar introuvable"
            exit 1
          fi
          
          if [ -d ./artifact/app.jar ]; then
            echo "âŒ Erreur: app.jar est un dossier, pas un fichier"
            exit 1
          fi
          
          JAR_SIZE=$(du -h ./artifact/app.jar | cut -f1)
          echo "âœ… Artefact vÃ©rifiÃ© (taille: $JAR_SIZE)"
          file ./artifact/app.jar

      # --------------------------------------------------------------------------
      # CrÃ©ation et nettoyage du rÃ©pertoire distant
      # --------------------------------------------------------------------------
      - name: ğŸ“ Prepare remote directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ§¹ PrÃ©paration du rÃ©pertoire: $APP_DIR"
            
            mkdir -p "$APP_DIR"
            rm -rf "$APP_DIR/app.jar" "$APP_DIR/artifact" "$APP_DIR/target"
            
            if [ ! -w "$APP_DIR" ]; then
              echo "âŒ Erreur: Pas de permission d'Ã©criture sur $APP_DIR"
              exit 1
            fi
            
            echo "âœ… RÃ©pertoire prÃªt pour le dÃ©ploiement"

      # --------------------------------------------------------------------------
      # Transfert du JAR avec base64
      # --------------------------------------------------------------------------
      - name: ğŸ“¤ Transfer JAR to remote VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          ssh-keyscan -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          echo "ğŸ“¦ Informations sur le fichier source:"
          ls -lh ./artifact/app.jar
          file ./artifact/app.jar
          echo ""
          
          echo "ğŸ“¤ Transfert de app.jar vers la VM..."
          base64 ./artifact/app.jar | ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.PORT }} \
              -o StrictHostKeyChecking=no \
              "${{ secrets.USERNAME }}@${{ secrets.HOST }}" \
              "base64 -d > ${{ needs.configure.outputs.app-dir }}/app.jar"
          
          echo "âœ… Transfert terminÃ©"
          rm -f ~/.ssh/deploy_key

      # --------------------------------------------------------------------------
      # VÃ©rification du transfert
      # --------------------------------------------------------------------------
      - name: âœ… Verify transfer
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            
            echo "ğŸ” VÃ©rification du fichier transfÃ©rÃ©..."
            
            if [ ! -f "$APP_DIR/app.jar" ]; then
              echo "âŒ ERREUR: app.jar introuvable"
              ls -lah "$APP_DIR"
              exit 1
            fi
            
            JAR_SIZE=$(du -h "$APP_DIR/app.jar" | cut -f1)
            echo "âœ… Fichier JAR transfÃ©rÃ© avec succÃ¨s"
            echo "   ğŸ“ Chemin: $APP_DIR/app.jar"
            echo "   ğŸ“¦ Taille: $JAR_SIZE"
            ls -lh "$APP_DIR/app.jar"
            file "$APP_DIR/app.jar"

      # --------------------------------------------------------------------------
      # âœ… AMÃ‰LIORATION 2 : Configuration du service systemd
      # --------------------------------------------------------------------------
      - name: ğŸ”§ Setup systemd service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            PORT="${{ needs.configure.outputs.port }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            ENV_NAME="${{ needs.configure.outputs.env-name }}"
            SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”§ Configuration du service systemd"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Service: $SERVICE_NAME"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # CrÃ©ation du fichier service systemd
            sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null << EOF
            [Unit]
            Description=TestGithubActions Spring Boot Application ($ENV_NAME)
            After=network.target
            
            [Service]
            Type=simple
            User=$USER
            WorkingDirectory=$APP_DIR
            
            # Commande de dÃ©marrage
            ExecStart=/usr/bin/java \\
              -Xms256m \\
              -Xmx512m \\
              -XX:+UseG1GC \\
              -XX:MaxGCPauseMillis=200 \\
              -Dspring.profiles.active=$(echo $ENV_NAME | tr '[:upper:]' '[:lower:]') \\
              -Dspring.main.banner-mode=off \\
              -Djava.awt.headless=true \\
              -jar $APP_DIR/app.jar \\
              --server.port=$PORT
            
            # RedÃ©marrage automatique en cas d'erreur
            Restart=on-failure
            RestartSec=10
            
            # DÃ©lai avant SIGKILL aprÃ¨s SIGTERM
            TimeoutStopSec=30
            
            # Logs
            StandardOutput=append:$APP_DIR/$LOG_FILE
            StandardError=append:$APP_DIR/$LOG_FILE
            
            # Limites de ressources (optionnel)
            LimitNOFILE=65536
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Rechargement de systemd
            echo "ğŸ”„ Rechargement de systemd..."
            sudo systemctl daemon-reload
            
            # Activation du service au dÃ©marrage
            echo "âœ… Activation du service au boot..."
            sudo systemctl enable $SERVICE_NAME
            
            echo "âœ… Service systemd configurÃ© avec succÃ¨s"

      # --------------------------------------------------------------------------
      # ArrÃªt du service existant
      # --------------------------------------------------------------------------
      - name: ğŸ›‘ Stop existing service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
            
            echo "ğŸ” VÃ©rification de l'Ã©tat du service..."
            
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "âš ï¸  Service actif, arrÃªt en cours..."
              sudo systemctl stop $SERVICE_NAME
            
              # Attente de l'arrÃªt complet
              for i in {1..10}; do
                if ! sudo systemctl is-active --quiet $SERVICE_NAME; then
                  echo "âœ… Service arrÃªtÃ© proprement"
                  break
                fi
                echo "â³ Attente de l'arrÃªt... ($i/10)"
                sleep 1
              done
            else
              echo "â„¹ï¸  Service non actif"
            fi

      # --------------------------------------------------------------------------
      # DÃ©marrage du nouveau service
      # --------------------------------------------------------------------------
      - name: â–¶ï¸  Start new service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
            ENV_NAME="${{ needs.configure.outputs.env-name }}"
            PORT="${{ needs.configure.outputs.port }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ DÃ©marrage du service"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Service      : $SERVICE_NAME"
            echo "ğŸ“ Environnement: $ENV_NAME"
            echo "ğŸ”Œ Port         : $PORT"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # DÃ©marrage du service
            sudo systemctl start $SERVICE_NAME
            
            # Attente du dÃ©marrage
            echo "â³ Attente du dÃ©marrage (15 secondes)..."
            sleep 15
            
            # VÃ©rification du statut
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo "âœ… Service dÃ©marrÃ© avec succÃ¨s"
              echo ""
              echo "ğŸ“Š Statut du service:"
              sudo systemctl status $SERVICE_NAME --no-pager -l
            else
              echo "âŒ ERREUR: Le service n'a pas dÃ©marrÃ©"
              echo ""
              echo "ğŸ“‹ Logs du service:"
              sudo journalctl -u $SERVICE_NAME -n 50 --no-pager
              exit 1
            fi

  # ============================================================================
  # JOB 4 : VERIFICATION POST-DEPLOIEMENT
  # Tests de santÃ© et validation du dÃ©ploiement
  # ============================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: [configure, deploy]

    steps:
      # --------------------------------------------------------------------------
      # VÃ©rification du service systemd
      # --------------------------------------------------------------------------
      - name: ğŸ” Check service health
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
            PORT="${{ needs.configure.outputs.port }}"
            APP_DIR="${{ needs.configure.outputs.app-dir }}"
            LOG_FILE="${{ needs.configure.outputs.log-file }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” VERIFICATION DU SERVICE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # 1ï¸âƒ£ VÃ©rification du service systemd
            echo ""
            echo "1ï¸âƒ£  Service systemd:"
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              # RÃ©cupÃ©ration des infos du service
              PID=$(sudo systemctl show -p MainPID --value $SERVICE_NAME)
              UPTIME=$(ps -p $PID -o etime= | tr -d ' ')
              MEM=$(ps -p $PID -o rss= | awk '{printf "%.2f MB", $1/1024}')
            
              echo "   âœ… Service actif"
              echo "   ğŸ†” PID: $PID"
              echo "   â±ï¸  Uptime: $UPTIME"
              echo "   ğŸ’¾ MÃ©moire: $MEM"
            
              # Statut dÃ©taillÃ©
              echo ""
              sudo systemctl status $SERVICE_NAME --no-pager -l | head -15
            else
              echo "   âŒ ERREUR: Service inactif"
              echo ""
              echo "   ğŸ“‹ Logs d'erreur:"
              sudo journalctl -u $SERVICE_NAME -n 30 --no-pager
              exit 1
            fi
            
            # 2ï¸âƒ£ VÃ©rification du port
            echo ""
            echo "2ï¸âƒ£  Port d'Ã©coute:"
            if lsof -i:$PORT >/dev/null 2>&1; then
              echo "   âœ… Port $PORT en Ã©coute"
              lsof -i:$PORT | grep LISTEN | awk '{print "   ğŸ”Œ " $1 " (PID: " $2 ")"}'
            else
              echo "   âŒ ERREUR: Port $PORT non accessible"
              exit 1
            fi
            
            # 3ï¸âƒ£ VÃ©rification des fichiers
            echo ""
            echo "3ï¸âƒ£  Fichiers:"
            if [ -f "$APP_DIR/app.jar" ]; then
              JAR_SIZE=$(du -h "$APP_DIR/app.jar" | cut -f1)
              echo "   âœ… app.jar prÃ©sent ($JAR_SIZE)"
            fi
            
            if [ -f "$APP_DIR/$LOG_FILE" ]; then
              LOG_SIZE=$(du -h "$APP_DIR/$LOG_FILE" | cut -f1)
              LOG_LINES=$(wc -l < "$APP_DIR/$LOG_FILE")
              echo "   âœ… $LOG_FILE prÃ©sent ($LOG_SIZE, $LOG_LINES lignes)"
            fi
            
            # 4ï¸âƒ£ Analyse des logs
            echo ""
            echo "4ï¸âƒ£  Analyse des logs:"
            if [ -f "$APP_DIR/$LOG_FILE" ]; then
              if tail -100 "$APP_DIR/$LOG_FILE" | grep -q "Started.*Application in"; then
                STARTUP_TIME=$(tail -100 "$APP_DIR/$LOG_FILE" | grep "Started.*Application in" | tail -1 | grep -oP '\d+\.\d+(?= seconds)' || echo "N/A")
                echo "   âœ… Application dÃ©marrÃ©e avec succÃ¨s"
                echo "   âš¡ Temps de dÃ©marrage: ${STARTUP_TIME}s"
              fi
            
              if tail -100 "$APP_DIR/$LOG_FILE" | grep -qi "error\|exception"; then
                echo "   âš ï¸  Erreurs dÃ©tectÃ©es dans les logs"
              else
                echo "   âœ… Aucune erreur dÃ©tectÃ©e"
              fi
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --------------------------------------------------------------------------
      # Test de connectivitÃ© HTTP
      # --------------------------------------------------------------------------
      - name: ğŸŒ HTTP connectivity test
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            PORT="${{ needs.configure.outputs.port }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ TEST DE CONNECTIVITE HTTP"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            MAX_ATTEMPTS=10
            ATTEMPT=1
            SUCCESS=false
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ğŸ”„ Tentative $ATTEMPT/$MAX_ATTEMPTS..."
            
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$PORT/ 2>/dev/null || echo "000")
            
              if [ "$HTTP_CODE" != "000" ]; then
                RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" http://localhost:$PORT/ 2>/dev/null)
                echo "   âœ… RÃ©ponse HTTP: $HTTP_CODE"
                echo "   âš¡ Temps de rÃ©ponse: ${RESPONSE_TIME}s"
                SUCCESS=true
                break
              else
                echo "   â³ Pas de rÃ©ponse, attente de 5 secondes..."
                sleep 5
              fi
            
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo ""
            
            if [ "$SUCCESS" = true ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… DEPLOIEMENT REUSSI"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸŒ URL: http://207.180.240.150:$PORT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ECHEC DU DEPLOIEMENT"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi

      # --------------------------------------------------------------------------
      # Affichage des logs en cas d'Ã©chec
      # --------------------------------------------------------------------------
      - name: ğŸ“‹ Display logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ LOGS DU SERVICE (50 derniÃ¨res lignes)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            sudo journalctl -u $SERVICE_NAME -n 50 --no-pager
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # JOB 5 : NOTIFICATION
  # Notification du statut de dÃ©ploiement
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [configure, build, verify]
    if: always()

    steps:
      - name: ğŸ“¢ Deployment summary
        run: |
          ENV_NAME="${{ needs.configure.outputs.env-name }}"
          PORT="${{ needs.configure.outputs.port }}"
          BRANCH="${{ needs.configure.outputs.branch }}"
          VERSION="${{ needs.build.outputs.build-version }}"
          SERVICE_NAME="${{ needs.configure.outputs.service-name }}"
          
          if [ "${{ needs.verify.result }}" = "success" ]; then
            STATUS="âœ… SUCCES"
            COLOR="ğŸŸ¢"
          else
            STATUS="âŒ ECHEC"
            COLOR="ğŸ”´"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$COLOR DEPLOIEMENT $ENV_NAME - $STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branche      : $BRANCH"
          echo "ğŸ“ Environnement: $ENV_NAME"
          echo "ğŸ“¦ Version      : $VERSION"
          echo "ğŸ”Œ Port         : $PORT"
          echo "ğŸ”§ Service      : $SERVICE_NAME"
          echo "ğŸŒ URL          : http://207.180.240.150:$PORT"
          echo "ğŸ‘¤ Auteur       : ${{ github.actor }}"
          echo "ğŸ“ Commit       : ${{ github.sha }}"
          echo "â±ï¸  Date         : $(date '+%Y-%m-%d %H:%M:%S')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"