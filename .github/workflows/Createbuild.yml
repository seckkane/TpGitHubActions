name: Java CI/CD with Maven

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:

  # =========================
  # 1️⃣ Créer les dossiers DEV et PROD sur la VM
  # =========================
  Create-Folders:
    runs-on: ubuntu-latest
    steps:
      - name: Create DEV and PROD folders on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -x
            echo "Création des dossiers applicatifs DEV et PROD si inexistants"
            mkdir -p /opt/apps/dev/java/TestGithubActions
            mkdir -p /opt/apps/prod/java/TestGithubActions
            chown -R appuser:appuser /opt/apps/dev/java/TestGithubActions
            chown -R appuser:appuser /opt/apps/prod/java/TestGithubActions

  # =========================
  # 2️⃣ Build Maven + Copier le JAR sur la VM
  # =========================
  Build-and-Deploy:
    runs-on: ubuntu-latest
    needs: Create-Folders
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Rename JAR
        run: mv target/*.jar target/app.jar

      # Déterminer le dossier cible sur la VM selon la branche
      - name: Set target path
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            echo "TARGET_DIR=/opt/apps/dev/java/TestGithubActions/app.jar" >> $GITHUB_ENV
          else
            echo "TARGET_DIR=/opt/apps/prod/java/TestGithubActions/app.jar" >> $GITHUB_ENV
          fi

      - name: Copy JAR to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          source: "target/app.jar"
          target: ${{ env.TARGET_DIR }}

  # =========================
  # 3️⃣ Lancer l'application sur la VM
  # =========================
  RunScript:
    runs-on: ubuntu-latest
    needs: Build-and-Deploy
    steps:
      - name: Run Spring Boot app on VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Déterminer branche et environnement
            BRANCH_NAME=$(echo $GITHUB_REF | sed 's|refs/heads/||')
            if [ "$BRANCH_NAME" = "develop" ]; then
              ENV_DIR="/opt/apps/dev/java/TestGithubActions"
              PORT=9091
              LOG_FILE="app-dev.log"
            else
              ENV_DIR="/opt/apps/prod/java/TestGithubActions"
              PORT=9092
              LOG_FILE="app-prod.log"
            fi

            cd $ENV_DIR

            # Supprimer ancien JAR si présent
            if [ -f app.jar ]; then
              rm -f app.jar
            fi

            # Déplacer le nouveau JAR déjà copié par scp (assurez-vous que TARGET_DIR = ENV_DIR/app.jar)
            # Vérification
            if [ ! -f app.jar ]; then
              echo "❌ JAR manquant dans $ENV_DIR"
              exit 1
            fi

            # Kill application sur le port
            lsof -ti:$PORT | xargs kill -9 2>/dev/null || echo "Aucun processus à arrêter"

            sleep 2

            # Lancer l'application
            nohup java -jar app.jar --server.port=$PORT > $LOG_FILE 2>&1 &

            sleep 2
            echo "✅ Application lancée sur le port $PORT avec log $LOG_FILE"

  # =========================
  # 4️⃣ Vérifier que l'application écoute sur le port et logs
  # =========================
  VerifyApp:
    runs-on: ubuntu-latest
    needs: RunScript
    steps:
      - name: Verify DEV/PROD port and logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            BRANCH_NAME=$(echo $GITHUB_REF | sed 's|refs/heads/||')
            if [ "$BRANCH_NAME" = "develop" ]; then
              PORT=9091
              ENV_DIR="/opt/apps/dev/java/TestGithubActions"
              LOG_FILE="app-dev.log"
            else
              PORT=9092
              ENV_DIR="/opt/apps/prod/java/TestGithubActions"
              LOG_FILE="app-prod.log"
            fi

            # Vérifier port
            if ss -tulnp | grep -q ":$PORT"; then
              echo "✅ Application en écoute sur le port $PORT"
            else
              echo "❌ Application NON démarrée sur le port $PORT"
            fi

            # Afficher les 10 dernières lignes du log
            tail -n 10 $ENV_DIR/$LOG_FILE
